# -*- perl -*-

#
# Author: Slaven Rezic
#
# Copyright (C) 2002,2003,2004,2005,2006,2007,2008,2009,2010 Slaven Rezic. All rights reserved.
# This program is free software; you can redistribute it and/or
# modify it under the same terms as Perl itself.
#
# Mail: slaven@rezic.de
# WWW:  http://bbbike.sourceforge.net
#

use BBBikeUtil qw(is_in_path);
use BBBikeVar qw();
use Config qw(%Config);

$bbbike_makefile_admin = "";

$bbbike_makefile_admin .= <<EOF;
BBBIKE_STABLE_VERSION=	$BBBike::STABLE_VERSION
BBBIKE_DISTFILE_SOURCE=	distfiles/BBBike-\$(BBBIKE_STABLE_VERSION).tar.gz

EOF

######################################################################
# POD files
#
# grab a good pod2html XXX this is somewhat hacky

# I thought also about Pod::ProjectDocs for pod2html conversion, but
# the 0.31 version has some bugs (it cannot handle umlauts and
# entities correctly, see
# http://rt.cpan.org/Ticket/Display.html?id=25123)
# 0.34 has additional problems: it depends on Syntax::Highlight::Universal,
# which fails nearly everywhere, and the Pod-ProjectsDocs tarball is
# broken because of some additional dot files from MacOSX.
# 0.38 has no progress on the Syntax::Highlight::Universal issue.

my $bbbike_html_rule;
my $pod2html = is_in_path("mpod2html");
## perldoc.com seems to be dead.
#my $htmlroot = "--htmlroot http://www.perldoc.com/cpan";
## This unfortunately has only the core documentation
#my $htmlroot = "--htmlroot http://perldoc.perl.org/";
my $htmlroot = "--htmlroot http://search.cpan.org/perldoc?";

if ($pod2html) {
    my $patched_marek_pod_html = "/usr/local/src/CPAN/new.build/MarekPodHtml-0.49";
    if (-d $patched_marek_pod_html) {
	$pod2html = "$^X -I$patched_marek_pod_html $patched_marek_pod_html/blib/script/mpod2html";
    } else {
	warn "With the patched Marek::Pod::HTML one would get links to search.cpan.org/perldoc";
    }
}

use constant POD_POD   => 0;
use constant POD_HTML  => 1;
use constant POD_TITLE => 2; # XXX do not put double quotes into title
#        podfile         htmlfile             title
my @pods = 
    (
     [qw(README          doc/README.html),        "README für BBBike"],
     [qw(README.english  doc/README.english.html),"README for BBBike"],
     [qw(bbbike.pod      doc/bbbike.html),        "Dokumentation für BBBike"],
     [qw(doc/links.pod   doc/links.html),     "Links"],
     [qw(doc/watchsites.pod   doc/watchsites.html),     "Links mit stets aktuellem Inhalt"],
     [qw(doc/bbd.pod     doc/bbd.html),           "BBD file format"],
     [qw(doc/bbbike_internals.pod  doc/bbbike_internals.html),        "BBBike Internals"],
     );
my $all_pods = join " ", map { $_->[POD_POD] } @pods;
my $all_html = join " ", map { $_->[POD_HTML] } @pods;
my $really_all_html = "$all_html doc/podindex.html";
if (defined $pod2html) {
    # XXX here no $htmlroot
    $bbbike_html_rule = <<EOF;
$all_html:	$all_pods Makefile
	$pod2html -stylesheet html/bbbikepod.css -tocname http://bbbike.sourceforge.net/index -notoc -nowarnings $all_pods
	\$(CLEAN_AFTER_POD2HTML)
	mv bbd.html doc/
	mv bbbike_internals.html doc/
	mv links.html doc/
	mv watchsites.html doc/
	mv podindex.html doc/
	mv bbbike.html doc/
	mv README.html doc/
	mv README.english.html doc/
	# Fix warnings (http://rt.cpan.org/Public/Bug/Display.html?id=21622)
	# Fix links
	for f in $really_all_html; do \\
		perl -i -nle 'if (!/^Cannot find page.*on line/) { print }' \$\$f; \\
		perl -i -pe 's{(html/bbbikepod.css)}{../\$\$1}g' \$\$f; \\
		perl -i -pe 's{(images/)}{../\$\$1}g' \$\$f; \\
		perl -i -pe 's{Generated by Marek::Pod::HTML.*on.*}{}' \$\$f; \\
	done
	chmod ugo+r $really_all_html
EOF
} else {
    print STDERR <<EOF;
*** NOTE: if you want to build HTML documentation using "make bbbikedoc"
*** you should install Marek::Pod::HTML to get best results
EOF
    my $pod2html;
    if (-e "/usr/perl5.8.1/bin/pod2html") {
	$pod2html = "perl5.8.1 /usr/perl5.8.1/bin/pod2html";
    } elsif (-x "/usr/perl5.7.2/bin/pod2html") {
	# XXX --htmlroot with bugs: one level module names are not linked
	$pod2html = "/usr/perl5.7.2/bin/pod2html $htmlroot -css html/bbbikepod.css --header";
    } elsif (-x "/usr/perl5.6.0/bin/pod2html") {
	$pod2html = "/usr/perl5.6.0/bin/pod2html $htmlroot";
    } else {
	$pod2html = "pod2html";
    }
    $bbbike_html_rule = "";
    for my $poddef (@pods) {
	$bbbike_html_rule .= <<EOF
$poddef->[POD_HTML]: $poddef->[POD_POD]
	$pod2html --title "$poddef->[POD_TITLE]" $poddef->[POD_POD] > $poddef->[POD_HTML]
	\$(CLEAN_AFTER_POD2HTML)

EOF
    }
}

######################################################################
# Bundled distributions
my(@bundled_perl_module_dists) =
    qw(Tk-ContextHelp Tk-Enscript Tk-Getopt Tk-Autoscroll Tk-PathEntry
       Tk-CanvasFig BikePower savevars GD-Convert Tk-Splash
       Algorithm-GooglePolylineEncoding Http Msg
       Tk-SREZIC Tk-CanvasBalloon Tk-CanvasUtil Tk-LogScale
       Tk-ColorFlowChooser Tk-LayerEditor Tk-Placement
       Tk-StippleLine Tk-WidgetDump Win32Util WWWBrowser
       Tk-FlatCheckbox
      );
my $EXTMODCPANTOP = "$ENV{HOME}/src/CPAN";
if (!-e $EXTMODCPANTOP) {
    $EXTMODCPANTOP = "$ENV{HOME}/work2";
}
my $EXTMODPERLTOP = "$ENV{HOME}/src/perl";
if (!-e $EXTMODPERLTOP) {
    $EXTMODPERLTOP = "$ENV{HOME}/work2";
}
my(@EXTMODCPAN, @EXTMODPERL);
for my $module_dist (@bundled_perl_module_dists) {
    if (-e "$EXTMODCPANTOP/$module_dist") {
	push @EXTMODCPAN, $module_dist;
    } elsif (-e "$EXTMODPERLTOP/$module_dist") {
	push @EXTMODPERL, $module_dist;
    } else {
	if (defined $ENV{USER} && $ENV{USER} eq 'eserte') {
	    warn "Can't find $module_dist neither in $EXTMODCPANTOP nor in $EXTMODPERLTOP\n";
	}
    }
}
my $EXTMODCPAN = join(" ", @EXTMODCPAN);
my $EXTMODPERL = join(" ", @EXTMODPERL);

######################################################################

my $fbsdportsdir;
my $fbsdportsdir_is_current = 0;
if ($^O eq 'freebsd') {
    if (-d "$ENV{HOME}/work2/freebsd/ports") {
	$fbsdportsdir = "$ENV{HOME}/work2/freebsd/ports";
	$fbsdportsdir_is_current = 1;
    } else {
	$fbsdportsdir = "/usr/ports";
    }
}

$bbbike_makefile_admin .= <<'EOF'
#### RSYNCS ###############################################################
# XXX check which of the rsyncs are not obsolete!

BBBIKE_CS_DEST=user.cs.tu-berlin.de:www/bbbike
BBBIKE_CS_TEST_DEST=user.cs.tu-berlin.de:www/BBBike
BBBIKE_SF_DEST=bbbike.sourceforge.net:/home/groups/b/bb/bbbike
BBBIKE_SF_DIR=${.CURDIR}/projects/bbbike.sourceforge.net

BBBIKE_RADZEIT_USER=		root
#BBBIKE_RADZEIT_HOST=		bbbike.radzeit.de
#BBBIKE_RADZEIT_HOST=		bbbike.de
BBBIKE_RADZEIT_HOST=		78.47.225.30
BBBIKE_RADZEIT_OLD_APACHE_DIR=	/usr/local/apache/radzeit
BBBIKE_RADZEIT_APACHE_DIR=	/var/www/domains/radzeit.de/www/
BBBIKE_RADZEIT_CGI_DIR=		$(BBBIKE_RADZEIT_APACHE_DIR)/cgi-bin
BBBIKE_RADZEIT_HTDOCS_DIR=      $(BBBIKE_RADZEIT_APACHE_DIR)/public
BBBIKE_RADZEIT_DIR=		$(BBBIKE_RADZEIT_APACHE_DIR)/BBBike
BBBIKE_RADZEIT_DIR2=		$(BBBIKE_RADZEIT_APACHE_DIR)/BBBike2
BBBIKE_RADZEIT_DEST=		$(BBBIKE_RADZEIT_USER)@$(BBBIKE_RADZEIT_HOST):$(BBBIKE_RADZEIT_DIR)
BBBIKE_RADZEIT_DEST2=		$(BBBIKE_RADZEIT_USER)@$(BBBIKE_RADZEIT_HOST):$(BBBIKE_RADZEIT_DIR2)

BBBIKE_HOSTEUROPE_USER=	root
# XXX change this!
#BBBIKE_HOSTEUROPE_HOST=	bbbike.lvps83-169-19-137.dedicated.hosteurope.de
BBBIKE_HOSTEUROPE_HOST=	bbbike.de
BBBIKE_HOSTEUROPE_APACHE_DIR=/root/work/bbbike-webserver/

RSYNC=rsync
RSYNC_DATA_CMD=cd data && \
	    $(RSYNC) --verbose --progress --recursive --compress --backup --perms --times \
		--exclude "*~" --exclude "RCS/" --exclude "*.st" \
		--exclude "*-orig" --exclude "*.inx" --exclude ".check*" \
		--exclude ".*.tmp" --exclude ".create_fragezeichen" --exclude ".???ignore" --exclude "Makefile*" \
		* .modified
RSYNC_RADZEIT_DATA=cd data_berlin_and_potsdam && $(RSYNC) -Pvzr . $(BBBIKE_RADZEIT_DEST)/data/
RSYNC_RADZEIT_TEST_DATA=cd data_berlin_and_potsdam && $(RSYNC) -Pvzr . $(BBBIKE_RADZEIT_DEST2)/data/

rsync-cs-data:
	$(RSYNC_DATA_CMD) $(BBBIKE_CS_DEST)/data

rsync-cs-test:
	cd $(BBBIKE_TMP)/BBBike && $(RSYNC) -Pvzr . $(BBBIKE_CS_TEST_DEST)/

rsync-sf-data:
	$(RSYNC_DATA_CMD) $(BBBIKE_SF_DEST)/cgi-bin/BBBike/data

#rsync-rezic-data:
#	$(RSYNC_DATA_CMD) www.rezic.de:/home/srezic

rsync-sf-all:
	cd $(BBBIKE_SF_DIR) && \
	    env BBBIKE_SRC_DIR=${.CURDIR} \
	        BBBIKE_SF_DEST=$(BBBIKE_SF_DEST) \
	        $(MAKE) update rsync

rsync-vran-spiff-hermes:
	[ "$(HOST)" = "vran.herceg.de" ]
	[ "$(LOGNAME)" = "eserte" ]
	rsync -Pvzrl \
	     --exclude misc/download/ \
	     --exclude i386-linux/ \
	     --exclude i586-linux/ \
	     --exclude i686-linux/ \
	     --exclude i686-linux-64int-ld/ \
	     --cvs-exclude \
	     ${.CURDIR}/ hermes@spiff:/home/hermes/src/bbbike/

######################################################################
# CVS handling (mirror to the now deprecated CVS repository, but
# automatic pushes still occur)

CVS_DIR=${HOME}/work/bbbike.CVS

# old name was cvs-everything:
cvs-chain:	copy-to-cvs \
		cvs-add-missing \
		cvs-standard-commit

# XXX create or copy .cvsignore with ext/*/*Dist.pm files
copy-to-cvs:	ask-copy-to-cvs do-copy-to-cvs

ask-copy-to-cvs:
	@echo -n "Really copy to ${CVS_DIR}? (Hit Ctrl-C otherwise) "
	@read dummy

MANIFEST_WITHCVS=	/tmp/MANIFEST.withcvs
.PHONY: $(MANIFEST_WITHCVS)
$(MANIFEST_WITHCVS):
	git ls-files > $(MANIFEST_WITHCVS)

do-copy-to-cvs:	$(MANIFEST_WITHCVS)
	perl "-MExtUtils::Manifest=manicopy,maniread" -e '$$fs=maniread(q{$(MANIFEST_WITHCVS)}); while($$f=each %$$fs) { if (-e qq{${CVS_DIR}/$$f} && -M $$f >= -M qq{${CVS_DIR}/$$f}) { delete $$fs->{$$f} } } manicopy($$fs,q{${CVS_DIR}}, q{cp}); utime time,time,map { qq{${CVS_DIR}/$$_} } keys %$$fs'

# Slow, aber gruendlich! Problem with do-copy-to-cvs may be that
# timestamps are incorrect.
do-copy-to-cvs-slow: $(MANIFEST_WITHCVS)
	perl "-MExtUtils::Manifest=manicopy,maniread" -e "manicopy(maniread('$(MANIFEST_withcvs)'),'${CVS_DIR}', 'cp');"

# Show the diffs between the source BBBike directory and the CVS directory.
# This can also be used to get a list of removed files which are still
# in the CVS repository.
diff-with-cvs:	$(MANIFEST_WITHCVS)
	makepatch --verbose \
	    -oldmanifest $(MANIFEST_WITHCVS) -newmanifest $(MANIFEST_WITHCVS) \
	    -diff "diff -up -I '\$$Id.*\$$' -I '\$$Revision.*\$$'" \
	    -descr "" \
	    ${CVS_DIR} ${.CURDIR}
	@echo "Use"
	@echo "    make cvs-add-missing"
	@echo "for missing files in CVS"

cvs-add-missing-disconnected:
	@echo Do not use this command without doing cvs update -ko
	@sleep 5
	cd ${CVS_DIR} && cvsu | grep '^[\?D]' | cut -c2- | xargs cvsdo add

cvs-add-missing:
	cd ${CVS_DIR} && cvsu | grep '^[\?D]' | cut -c2- | xargs cvs add -ko

cvs-standard-commit:
	cd ${CVS_DIR} && cvs -q -z9 commit -m ""

# XXX not used anymore. check that everything's really in git and ../tmp/MANIFEST.withcvs is consistent, then delete it
MANIFEST.withcvs:	MANIFEST MANIFEST.addtocvs
	echo "# DO NOT EDIT. Generated by Makefile" > MANIFEST.withcvs
	cat MANIFEST | grep -v -f MANIFEST.delfromcvs >> MANIFEST.withcvs
	perl -nle '@exp = glob("$$_"); if (@exp > 1 || $$exp[0] ne $$_) { @exp = grep { not /flymake/ } @exp; } print join("\n", @exp)' MANIFEST.addtocvs | grep -v flymake >> MANIFEST.withcvs

# XXX delete it if MANIFEST.withcvs not used anymore
# MANIFEST.addtocvs is *not* constant, so arrange that MANIFEST.withcvs
# is always fired.
.PHONY: MANIFEST.withcvs

# XXX It would be nicer to use "cp" instead of "ln", but ExtUtils::Manifest is buggy
# XXX rewrite using git? needed at all?
full-cvs-dist:	MANIFEST.withcvs
	perl -MExtUtils::Manifest=manicopy,maniread -e 'manicopy(maniread("MANIFEST.withcvs"), "/tmp/BBBike-CVS", "ln")'

# XXX needed at all? in the times of git?
rsync-cvs-repository-from-sourceforge:
	[ -e $(HOME)/bak ]
	mkdir -p $(HOME)/bak/bbbike-cvsroot
	cd $(HOME)/bak/bbbike-cvsroot && \
	    rsync -av rsync://bbbike.cvs.sourceforge.net/cvsroot/bbbike/ ./

######################################################################
# DISTRIBUTIONS

TMPDIR?=	/tmp
BBBIKE_TMP=     $(TMPDIR)/$(DISTNAME)

EOF
.
    "DEVEL_ARCH=       \$(TMPDIR)/\$(DISTVNAME)-" .
                        sprintf("%04d%02d%02d",
                               sub { $_[5]+1900, $_[4]+1, $_[3] }->(localtime)
                              ) . "-devel.zip\n\n" .

    <<'EOF'
#### development + distribution ##########################################

dist-to-tmp:
	$(PERL) -MExtUtils::Manifest=manicopy,maniread -e "manicopy(maniread(),'$(TMPDIR)/$(DISTVNAME)','best')"
	find $(TMPDIR)/$(DISTVNAME) -type d -exec chmod ugo+rx {} \;
	find $(TMPDIR)/$(DISTVNAME) -type f -exec chmod ugo+r {} \;


# bbbike.cgi #####################
# XXX not in use anymore and probably obsolete

CGI_ARCH=	$(TMPDIR)/bbbikecgi.zip
CGI2_ARCH_PROG= $(TMPDIR)/bbbikecgi_prog.zip
CGI2_ARCH_WEB=  $(TMPDIR)/bbbikecgi_web.zip

# CGI-Distribution: alle Dateien in einer Hierarchie
cgidist: cgidistdir
	$(RM_F) $(CGI_ARCH)
	cd $(BBBIKE_TMP) && $(ZIP) $(ZIPFLAGS) $(CGI_ARCH) $(DISTNAME)

cgidistdir:   MANIFEST.bbbikecgi
	$(RM_RF) $(BBBIKE_TMP)
	$(MKPATH) $(BBBIKE_TMP)
	$(PERL) -I$(PERL_ARCHLIB) -I$(PERL_LIB) \
		-MExtUtils::Manifest=manicopy,maniread \
                -e "manicopy(maniread(q{MANIFEST.bbbikecgi}),q{$(BBBIKE_TMP)/$(DISTNAME)}, q{$(DIST_CP)});"

cgidistdir-berlin-potsdam:   MANIFEST.bbbikecgi
	$(RM_RF) $(BBBIKE_TMP)
	$(MKPATH) $(BBBIKE_TMP)
	$(PERL) -I$(PERL_ARCHLIB) -I$(PERL_LIB) \
		-MExtUtils::Manifest=manicopy,maniread \
                -e '$$files = maniread(q{MANIFEST.bbbikecgi}); \
		    for (keys %$$files) { \
		      if (m|^data/(.*)|) { $$data->{$$1}=""; delete $$files->{$$_} } \
		    } \
		    manicopy($$files,q{$(BBBIKE_TMP)/$(DISTNAME)}, q{$(DIST_CP)}); \
		    chdir "data" or die "Cannot change to data directory: $$!"; \
		    manicopy($$data,q{$(BBBIKE_TMP)/$(DISTNAME)/data}, q{$(DIST_CP)}); \
'

# Alternative: Programme unter cgi-bin, Rest in ein BBBike-Verzeichnis
cgidist2:
	$(RM_F) $(CGI2_ARCH_PROG) $(CGI2_ARCH_WEB)
	$(RM_RF) $(BBBIKE_TMP)
	$(MKPATH) $(BBBIKE_TMP)
	$(PERL) -I$(PERL_ARCHLIB) -I$(PERL_LIB) \
		-MExtUtils::Manifest=manicopy,maniread \
                -e "manicopy(maniread(q{MANIFEST.bbbikecgi.prog}),q{$(BBBIKE_TMP)/$(DISTNAME)}, q{$(DIST_CP)});"
	$(MV) $(BBBIKE_TMP)/$(DISTNAME)/cgi/* $(BBBIKE_TMP)
	cd $(BBBIKE_TMP) && $(ZIP) $(ZIPFLAGS) $(CGI2_ARCH_PROG) .
	$(RM_RF) $(BBBIKE_TMP)
	$(MKPATH) $(BBBIKE_TMP)
	$(PERL) -I$(PERL_ARCHLIB) -I$(PERL_LIB) \
		-MExtUtils::Manifest=manicopy,maniread \
                -e "manicopy(maniread(q{MANIFEST.bbbikecgi.web}),q{$(BBBIKE_TMP)/$(DISTNAME)}, q{$(DIST_CP)});"
	cd $(BBBIKE_TMP) && $(ZIP) $(ZIPFLAGS) $(CGI2_ARCH_WEB) $(DISTNAME)

# In beiden MANIFEST-Dateien sind images enthalten, weil images sowohl vom
# Browser aus, als auch bei der PNG/GIF-Erstellung verwendet werden.
MANIFEST.bbbikecgi:	MANIFEST.bbbikecgi.prog MANIFEST.bbbikecgi.web
	echo "# DO NOT EDIT! Generated by Makefile" > MANIFEST.bbbikecgi
	cat MANIFEST.bbbikecgi.prog MANIFEST.bbbikecgi.web >> MANIFEST.bbbikecgi

cgidist-cs:	cgidistdir-berlin-potsdam
	cp -fp cgi/bbbike-cs.cgi.config $(BBBIKE_TMP)/$(DISTNAME)/cgi/bbbike.cgi.config

# cbbbike #####################

CBBBIKE_ARCH=      $(TMPDIR)/cbbbike.zip
CBBBIKE_DOS_ARCH=  $(TMPDIR)/cbbbike_dos.zip
RECODE=            recode

.PHONY: ChangeLog develdist makepatch cbbbikedist cbbbikedistdit
.PHONY: cbbbikedosdist cbbbikedosdistdir cgidist cgidistdir
.PHONY: ext distdir2

cbbbikedist: cbbbikedistdir
	$(RM_F) $(CBBBIKE_ARCH)
	cd $(TMPDIR) && $(ZIP) $(ZIPFLAGS) $(CBBBIKE_ARCH) $(DISTNAME)

cbbbikedistdir:
	$(RM_RF) $(BBBIKE_TMP)
	$(PERL) -I$(PERL_ARCHLIB) -I$(PERL_LIB) -MExtUtils::Manifest=manicopy,maniread \
                -e "manicopy(maniread(\'MANIFEST.cbbbike\'),\'$(BBBIKE_TMP)\', \'$(DIST_CP)\');"

# cbbbikedosdist: wie cbbbikedist, nur wird noch zusätzlich mit recode
# nach cp850 (besser als cp437) konvertiert
cbbbikedosdist: cbbbikedosdistdir
	$(RM_F) $(CBBBIKE_DOS_ARCH)
	cd $(TMPDIR) && $(ZIP) $(ZIPFLAGS) $(CBBBIKE_DOS_ARCH) $(DISTNAME)

cbbbikedosdistdir: cbbbikedistdir
	cd $(BBBIKE_TMP) && chmod u+w *; $(RECODE) latin1:cp850 *.pm cbbbike; chmod 755 cbbbike
	cd $(BBBIKE_TMP)/data && chmod u+w *; $(RECODE) latin1:cp850 *

distdir2:
	umask 022 && $(MAKE) $(MAKEFLAGS) distdir
	# for testing with extension based systems like Windows
	cd $(DISTVNAME) && ln -s bbbike bbbike.pl
	-rm -fr /tmp/$(DISTVNAME)
	ln -s `pwd`/$(DISTVNAME) /tmp/$(DISTVNAME)

develdist:
	rm -rf $(DEVEL_ARCH)
	cd .. && $(ZIP) $(ZIPFLAGS) $(DEVEL_ARCH) bbbike \
	    -x \*.tar.gz \
	    -x \*/old/\* \
	    -x \*/cache/\* \
	    -x \*/tmp/\* \
	    -x \*/vbbdata/\* \
	    -x \*/c/minibbbike \
	    -x \*/datagdf_berlin/\* \
	    -x \*/datagdf_brandenburg/\* \
	    -x \*/datagdf_mitte/\* \
	    -x \*/datagdf_*/\* \
	    -x \*/datagdf/\* \
	    -x \*/diplom/\* \
	    -x \*/CRASH/\* \
	    -x \*/distfiles/\* \
	    -x \*/i386-freebsd/\* \
            -x \*/i386-freebsd-64int/\* \
            -x \*/i386-freebsd-thread/\* \
	    -x \*/i586-linux/\* \
	    -x \*/blib \
	    -x \*/blib/\* \
	    -x \*/pm_to_blib \
 	    -x \*/.xvpics/\* \
	    -x \*/misc/adressen/\* \
	    -x \*/misc/Berlin_Mitte.gdf \
	    -x \*/palm/test/\* \
	    -x \*/palm/test2/\* \
	    -x \*/projects/\* \
	    -x \*/vbbbike/vbbbike \
	    -x \*.o \
	    -x \*.so \
	    -x \*.bs \
	    -x \*.old \
	    -x \*.core \
	    -x \*.out \
	    -x \*.grc \
	    -x \*.bin \
	    -x \*/#*# \
	    -x \*.gdbinit \
	    -x \*.bak \
	    -x \*~

predist:
	cd data && ${MAKE}
	${MAKE} generatemods
	${MAKE} extmod
	${MAKE} copyextmod
	${MAKE} bbbikedoc
	${MAKE} distcheck
	${MAKE} distdir
	${MAKE} bundles
	@echo check bbbike in BBBike-$(VERSION) directory

######################################################################
# DOCUMENTATION

CLEAN_AFTER_POD2HTML=$(RM_F) pod2html-*cache pod2htm?.?~~

README:	README.tpl BBBikeVar.pm
	tpage --define lang=DE --eval_perl README.tpl > README~
	mv README~ README

README.english: README.tpl BBBikeVar.pm
	tpage --define lang=EN --eval_perl README.tpl > README.english~
	mv README.english~ README.english

EOF
. $bbbike_html_rule . <<'EOF'

doc/HOWTO_edit_bbbike_data.html: doc/HOWTO_edit_bbbike_data.sgml doc/Makefile.doc
	cd doc && env LANG=C LC_ALL=C $(MAKE) -f Makefile.doc HOWTO_edit_bbbike_data.html

clean_pod2html:

EOF
. "bbbikedoc:	README README.english $all_html doc/HOWTO_edit_bbbike_data.html\n" . <<'EOF'

clean_cache:
	echo rm -rf cache/*

# Alternative Pod generator using Pod::ProjectDocs, looks like CPAN docs
pod-projdocs:
	pod2projdocs -title BBBike -desc "Der Fahrradroutenplaner für Berlin und Brandenburg" -verbose -charset "iso-8859-1" -out /tmp/pods/ -lib `pwd`

######################################################################
# PORTS, BINDISTS...

######################################################################
# FreeBSD

EOF
. <<"EOF"
fbsdport:
	cd port/freebsd && env TMPDIR=\$(TMPDIR) ./mkport.pl -portsdir $fbsdportsdir

EOF
. <<'EOF'
#XXX -useversion devel NYI
#fbsdport-devel:
#	cd port/freebsd && env TMPDIR=$(TMPDIR) ./mkport.pl -useversion devel

fbsdport-distfiles-link:
	[ -d /usr/ports/distfiles ] && \
	[ -w /usr/ports/distfiles ] && \
	[ ! -e /usr/ports/distfiles/BBBike-$(VERSION).tar.gz ] && \
	ln -s ${.CURDIR}/distfiles/BBBike-$(VERSION).tar.gz /usr/ports/distfiles || \
	exit 0

fbsdportdiff: fbsdport do-fbsdportdiff

fbsdportdiff-devel: fbsdport-devel do-fbsdportdiff

EOF
. <<"EOF"
do-fbsdportdiff:
	if @{[ $fbsdportsdir_is_current ? "true" : "false" ]} ; \\
	then \\
	    echo "INFO: first updating ports directory..."; \\
	    (cd $fbsdportsdir/german/BBBike && cvs update); \\
	    echo "INFO: now creating patch..."; \\
	    makepatch --exclude-vc --exclude 'work/*' $fbsdportsdir/german/BBBike \$(TMPDIR)/BBBike > \$(TMPDIR)/bbbike-freebsdport.diff; \\
	else \\
	    echo "WARNING: diff'ing against possibly outdated ports tree"; \\
	    makepatch --exclude 'work/*' $fbsdportsdir/german/BBBike \$(TMPDIR)/BBBike > \$(TMPDIR)/bbbike-freebsdport.diff ; \\
	fi

EOF
. <<'EOF'
VARPORTDIR=/var/tmp/BBBike
TMPPORTDIR=$(TMPDIR)/BBBike

# Taken form porters handbook, Automated package list creation
fbsdport-pkg-plist-check: fbsdport
	perl -le 'exit !(shift =~ m{^/var/tmp/})' ${VARPORTDIR}
	rm -rf ${VARPORTDIR}
	mkdir ${VARPORTDIR}
	mtree -U -f /etc/mtree/BSD.local.dist -d -e -p ${VARPORTDIR}
	cd ${TMPPORTDIR} && make clean depends PREFIX=${VARPORTDIR}
	(cd ${VARPORTDIR} && find -d * -type d) > ${TMPDIR}/OLD-DIRS
	cd ${TMPPORTDIR} && make install PREFIX=${VARPORTDIR}
	(cd ${VARPORTDIR} && find -d * \! -type d) | sort > ${TMPDIR}/pkg-plist
	(cd ${VARPORTDIR} && find -d * -type d) | comm -13 ${TMPDIR}/OLD-DIRS - | sed -e 's#^#@dirrm #' | perl -le 'print join "", sort { (length($$b) <=> length($$a)) || ($$b cmp $$a) } <>' >> ${TMPDIR}/pkg-plist
	diff -u ${TMPPORTDIR}/pkg-plist ${TMPDIR}/pkg-plist

######################################################################
# Windows

BBBIKE_WINDOWS_VERSION=$(VERSION)
WINBINDISTDIR=$(TMPDIR)/BBBike-$(BBBIKE_WINDOWS_VERSION)-Windows
# XXX use another bbbike.bat/setup.bat if activeperl-613 would be used...
WINPERLBIN=$(HOME)/src/binperl/sieperl-5.6.1
# XXX the bbbike version should not be hardcoded here!!!
PATCHBINPERLROOT=$(HOME)/src/binperl/sieperl-5.6.1-bbbike-3.16-DEVEL
WINBINDIST=$(WINBINDISTDIR).zip

winbindist-pre:	winbindist-clean winbindist-copy

winbindist-clean:
	rm -rf $(WINBINDISTDIR)

winbindist-copy:
	[ ! -d $(WINBINDISTDIR) ]
	@echo "Make sure that the distfile is uptodate"
	umask 022; mkdir $(WINBINDISTDIR)
	umask 022; cp -Rp $(WINPERLBIN) $(WINBINDISTDIR)
	mv $(WINBINDISTDIR)/`basename $(WINPERLBIN)` $(WINBINDISTDIR)/windows
	umask 022; cp -Rpf $(PATCHBINPERLROOT)/* $(WINBINDISTDIR)/windows
	umask 022; if [ -r distfiles/BBBike-$(BBBIKE_WINDOWS_VERSION).tar.gz ] ; then \
	    cat distfiles/BBBike-$(BBBIKE_WINDOWS_VERSION).tar.gz | (cd $(WINBINDISTDIR) && tar xfvz - ); \
	elif [ -r BBBike-$(BBBIKE_WINDOWS_VERSION).tar.gz ]; then \
	    cat BBBike-$(BBBIKE_WINDOWS_VERSION).tar.gz | (cd $(WINBINDISTDIR) && tar xfvz - ); \
	else \
	    $(MAKE) distdir; \
	    cp -Rp BBBike-$(BBBIKE_WINDOWS_VERSION) $(WINBINDISTDIR); \
	    chmod ugo+rx $(WINBINDISTDIR)/BBBike-$(BBBIKE_WINDOWS_VERSION); \
	fi
	mv $(WINBINDISTDIR)/BBBike-$(BBBIKE_WINDOWS_VERSION) $(WINBINDISTDIR)/bbbike
	find $(WINBINDISTDIR)/bbbike -type d -print0 | xargs -0 chmod ugo+r
	umask 022; cp -p cdrom/windows/autorun.inf \
	      cdrom/windows/bbbike.bat \
	      cdrom/windows/oldsetup.bat \
	      cdrom/windows/oldsetup.pl \
	    $(WINBINDISTDIR)
# put this again to the distribution if it really works!
#	      cdrom/windows/setup.exe

winbindist: winbindist-pre
	cd $(WINBINDISTDIR)/.. && umask 022; zip -r $(WINBINDIST) `basename $(WINBINDISTDIR)`
	chmod 644 $(WINBINDIST)

#XXX	[ -d /usr/ports/distfiles -a ! -l /usr/ports/distfiles/BBBike-$(VERSION)-Windows.zip ] && ln -s 

######################################################################
# Debian

# Debian packages needed for (subparts of) BBBike, loosely
# categorized:
DEB_DEVEL=	git-core bison byacc flex g++ apt-show-versions pmake gcc \
		libc6-dev libinline-perl strace rsync less make
DEB_TEST=	libimage-info-perl libwww-mechanize-perl
DEB_DRAW=	libgd2-xpm libgd2-xpm-dev perlmagick libimager-perl \
		pdftk netpbm imagemagick libgd-gd2-perl ttf-bitstream-vera \
		libpdf-create-perl libfont-afm-perl \
		libtest-number-delta-perl \
		libsvg-perl
DEB_MAIL=	libmime-lite-perl libmailtools-perl
DEB_DATA=	libstring-approx-perl libdbd-xbase-perl libxml-parser-perl \
		libxml-twig-perl libdbi-perl libtie-ixhash-perl \
		libobject-realize-later-perl libmldbm-perl \
		libclass-accessor-perl libarchive-zip-perl \
		libtemplate-perl libxml-libxml-perl libxml-simple-perl \
		libyaml-perl libyaml-syck-perl libjson-xs-perl \
		libtext-unidecode-perl libdata-compare-perl agrep
DEB_MISC=	libdate-calc-perl
# If apache2 is installed, then do not install apache-perl!
DEB_CGI=	libapache-session-perl apache-perl libfile-counterfile-perl
DEB_MAPSERVER=	mapserver-bin cgi-mapserver

# Debian packages from own repo
OWN_DEB=	libapache-session-counted-perl libpalm-palmdoc-perl \
		libgd-svg-perl libgeo-spacemanager-perl \
		libgeo-distance-perl libgeo-distance-xs-perl \
		libobject-iterate-perl libkwalify-perl libcdb-file-perl

# All packages needed for full-flavoured Web server operation:
DEB_ALL_CGI=	$(DEB_DEVEL)      \
		$(DEB_TEST)       \
		$(DEB_DRAW)       \
		$(DEB_MAIL)       \
		$(DEB_DATA)       \
		$(DEB_MISC)       \
		$(DEB_CGI)        \
		$(DEB_MAPSERVER)  

install-debian-for-cgi:	install-debian-packages-for-cgi \
			install-debian-owndebs-for-cgi

install-debian-packages-for-cgi:
	aptitude install ${DEB_ALL_CGI}

# Assumes own deb packages are in ~/work/mydebs
install-debian-owndebs-for-cgi:
	cd ${HOME}/work/mydebs && \
	    dpkg --install ${OWN_DEB}

# Not used:
install-debian-perlmods-for-cgi-via-cpan:
	cpan CPAN
	cpan PDF::Image::GIFImage Apache::Session::Counted \
	     Object::Iterate Palm::PalmDoc SVG WWW::Mechanize::FormFiller
# Manchmal scheint hier -f (force) notwendig zu sein...
	cpan CDB_File

######################################################################
# par

pardist:
	test -f $(BBBIKE_DISTFILE_SOURCE)
	zcat $(BBBIKE_DISTFILE_SOURCE) | (cd /tmp && tar xfv -)
	$(PERL) -MExtUtils::Manifest=maniread -e 'print join("\n", sort keys %{ maniread() })' | grep -v '^bbbike$$' > /tmp/bbbike-MANIFEST
	cd /tmp/BBBike-$(BBBIKE_STABLE_VERSION) && \
	    pp -A /tmp/bbbike-MANIFEST -vv -o /tmp/bbbike-$(BBBIKE_STABLE_VERSION)-$(OSNAME) bbbike

########################################################################

Makefile : Makefile_admin_PL

alldist: bbbikedoc dist dist_mv makepatch fbsdport fbsdport-distfiles-link \
	 winbindist ChangeLog

dist_mv:
	[ -d distfiles ] && true || mkdir distfiles
	mv -i BBBike-$(VERSION).tar.gz distfiles/

BACKUP_FILE=	/home5/bak/bbbike-devel.tar.gz

backup:
	-[ -f ${BACKUP_FILE} ] && mv -f ${BACKUP_FILE} ${BACKUP_FILE}~
	cd .. && tar -c -v -z -f ${BACKUP_FILE} --exclude "*.tar.gz" --exclude "*patch.gz" --exclude "*~" bbbike

# XXX Problem: binary files (xdelta? uuencode? nix?)
makepatch:
#	./miscsrc/mymakepatch.pl $(NAME)

rcslabel:
	$(PERL) -I$(PERL_ARCHLIB) -I$(PERL_LIB) -MExtUtils::Manifest=maniread \
		-e "@all = keys %{ maniread() };" \
		-e 'print("Executing $(RCS_LABEL) ...\n"); system("$(RCS_LABEL) @all");'

autoload:
	./miscsrc/make_autoload.pl -dd -f \
	    Strassen/Core.pm Strassen/Fast.pm Strassen/Kreuzungen.pm \
	    Strassen/MultiBezStr.pm Strassen/MultiStrassen.pm \
	    Strassen/Strasse.pm Strassen/StrassenNetz.pm Strassen/Util.pm

# Pfad zum mymake-Skript, das Makefile.PL's für ~/lib/perl erzeugt
# Da vieler meiner Skripte Test.pm verwenden, wird das nicht mit 5.004 gehen
# XXX mymake ist nur auf meiner Platte vorhanden!
EOF
		    . "MYEXTMODMAKE=	\$(HOME)/src/mymake -perl $^X\n"
		    . <<EOF
# normales Erzeugen mit: \$(FULLPERL) Makefile.PL
# "offizielle" Module
EXTMODCPANTOP=	$EXTMODCPANTOP
EXTMODCPAN=	$EXTMODCPAN
# "experimentelle" Module
EXTMODPERLTOP=	$EXTMODPERLTOP
EXTMODPERL=	$EXTMODPERL

EOF
		    . <<'EOF'

echoextmodcpantop:
	@echo $(EXTMODCPANTOP)

echoextmodcpan:
	@echo $(EXTMODCPAN)

echoextmodperltop:
	@echo $(EXTMODPERLTOP)

echoextmodperl:
	@echo $(EXTMODPERL)

# baut und installiert die externen Module wie BikePower etc.
# verwendet Xfvb oder Xnest
# XXX testen, ob man überhaupt einen X-Server hat
#	alternative: Xnest -ac -geometry 640x400 :121 &
extmod:
	Xvfb -fp /usr/X11R6/lib/X11/fonts/misc -ac :121 & \
	_XVFB_PID=$$!; \
	DISPLAY=:121; \
	for i in $(EXTMODCPAN); do \
	    echo $$i; \
	    cd $(EXTMODCPANTOP)/$$i; \
		$(MYEXTMODMAKE) && \
		make && \
		BATCH=yes make test && \
		make install; \
	done; \
	for i in $(EXTMODPERL); do \
	    echo $$i; \
	    cd $(EXTMODPERLTOP)/$$i; \
		$(MYEXTMODMAKE) && \
		make && \
		BATCH=yes make test && \
		make install; \
	done; \
	echo Kill process $$_XVFB_PID; \
	kill -TERM $$_XVFB_PID
EOF
. <<EOF

copyextmod:
	$^X ./miscsrc/link_ext_mod.pl -copy -v
EOF
. <<'EOF'

generatemods: Strassen/Generated.pm

bundles:
	$(FULLPERL) Makefile.PL -action make_bundle && \
	    $(FULLPERL) Makefile.PL -action make_small_bundle && \
	    $(FULLPERL) Makefile.PL -action make_cgi_bundle && \
	    $(FULLPERL) Makefile.PL -action make_windist_bundle

# OSD bundles are not supported anymore
bundles-osd:
	if [ ! -h Bundle/make_pi_osd ] ; then \
	    ln -s ../Makefile.PL Bundle/make_pi_osd; \
	fi
	if [ ! -h Bundle/make_small_pi_osd ] ; then \
	    ln -s ../Makefile.PL Bundle/make_small_pi_osd; \
	fi
	cd Bundle && $(FULLPERL) make_pi_osd unix; \
		     $(FULLPERL) make_pi_osd win; \
		     $(FULLPERL) make_small_pi_osd unix; \
		     $(FULLPERL) make_small_pi_osd win

Strassen/Generated.pm: Strassen/Generated_src.pm Strassen.pm
	chmod u+w Strassen/Generated.pm
	echo "1;" > Strassen/Generated.pm
	cd Strassen && perl -I../lib Generated_src.pm
	perl -Ilib -c Strassen/Generated_src.pm
	chmod ugo+r,-w Strassen/Generated.pm

echoversion:
	@echo 1>&2 This rule is obsolete ... use BBBikeVar.pm
	@echo $(VERSION)

# find perl scripts and modules
FIND_PERL_SCRIPTS=-type f -a \( -name "*.pm" -o -name "*.pl" -o -name "*.cgi" -o -name "bbbike" -o -name "cbbbike" \)

# Create a crypted perl distribution. The generated scripts should be called
# using ~/private/src/decrypt/perl.
encrypt:
	cd $(TMPDIR) && tar xfvz ${.CURDIR}/distfiles/$(DISTVNAME).tar.gz
	cd $(HOME)/private/src/decrypt && find $(TMPDIR)/$(DISTVNAME) $(FIND_PERL_SCRIPTS)  -print -exec ./encrypt {} \;

# Create a mangled, comment-less, pod-less minimal version of the script
# and modules. Savings are minimal: about 10% space for the distribution,
# about 1s for startup and nearly no RAM benefits.
mangle:
	cd $(TMPDIR) && tar xfvz ${.CURDIR}/distfiles/$(DISTVNAME).tar.gz
	cd $(TMPDIR)/$(DISTVNAME) && \
	    find . $(FIND_PERL_SCRIPTS) -print \
		-exec mv {} {}~ \; \
		-exec perltidy -t -mangle -dac -dp {}~ -o {} \; \
		-exec rm -f {}~ \;

# Fix the permissions. Needed mainly for correct cgi/mod_perl
# operation.
permission:
	perl -MExtUtils::Manifest=maniread -le 'print join "\n", sort keys %{ maniread("MANIFEST") }' | xargs chmod ugo+r
	chmod ugo+rx bbbike cgi/*.cgi
	chmod ugo+r cgi/*.config
	chmod ugo+rx data/temp_blockings
	chmod ugo+r  data/temp_blockings/*

# Copy the current BBBike source first to CVS, and then to a USB
# stick. The USB stick will be automatically mounted on FreeBSD, if
# necessary, and optionally unmounted after copying.
# The camcontrol commands were not necessary for 4.9, but are for 4.11
# Removed for 6.x, here for documentation:
#	    sudo camcontrol reset all;
#	    sudo camcontrol rescan all;
# FreeBSD 6.x names the old mount_msdos now mount_msdosfs
#
# The correct rsync seems to be tricky. -a does not seem to work well,
# as rsync tries to copy everything every time. -c seems to be better.
# --inplace should be safe enough; data on the stick are not precious
# in this stage.
USB_STICK_NUMBER=0
copy-cvs-to-stick:
	@echo 'Assume that CVS is up-to-date...'
	@[ ! -d /mnt/stick ] && ( \
	    echo -n "Create the mount directory /mnt/stick? (CTRL-C to abort)"; \
	    read yn; \
	    sudo mkdir /mnt/stick; \
	) || true
	-(mount | grep -q /mnt/stick) || ( \
	    sudo mount_msdosfs -u eserte /dev/da$(USB_STICK_NUMBER)s1 /mnt/stick \
	)
	mount | grep -q /mnt/stick
	@echo -n '*** Backup old BBBike-CVS directory on stick? (y/N) '
	-@read yn && ([ "$$yn" = "y" ] && mv /mnt/stick/BBBike-CVS /mnt/stick/BBBike-CVS.old || true)
	chmod -R u+rw /mnt/stick/BBBike-CVS/
	rsync -v --exclude ".#*" --inplace -c -rLt $(CVS_DIR)/ /mnt/stick/BBBike-CVS/
	#rsync -v -a $(CVS_DIR)/ /mnt/stick/BBBike-CVS/
	@echo -n '*** Unmount stick? (CTRL-C to abort)'
	@read yn
	sudo umount /mnt/stick

.PHONY: data

data:
	cd data && ${MAKE}

BBBikeVar.tpl: BBBikeVar.pm
	./miscsrc/ttdump --package BBBike --prefix BBBike BBBikeVar.pm > BBBikeVar.tpl

clean-cache:
	-rm -f tmp/b_de_*
	-rm -f tmp/m_de_*
	-rm -f tmp/*.cache

######################################################################
# Towards git
bbbike-rcs-to-cvs-repo:
	[ -d ${.CURDIR}/../bbbike-cvs-rcs ]
	cd ${.CURDIR} && rcs2cvsrepo.pl -f ${.CURDIR}/../bbbike-cvs-rcs/bbbike

git-update-local:	bbbike-rcs-to-cvs-repo
	[ -d ${.CURDIR}/../bbbike-gitlocal ]
	cd ${.CURDIR}/../bbbike-gitlocal && env CVS_RSH=ssh git cvsimport -v -d ${.CURDIR}/../bbbike-cvs-rcs bbbike -a

git-update-sf:	do-git-update-sf data-sf-fix-permissions

do-git-update-sf:
	[ -d ${.CURDIR}/../bbbike-gitsf ]
	cd ${.CURDIR}/../bbbike-gitsf && env CVS_RSH=ssh git cvsimport -v -d :ext:eserte@bbbike.cvs.sourceforge.net:/cvsroot/bbbike bbbike -a

data-sf-fix-permissions:
	cd ${.CURDIR}/../bbbike-gitsf/data && ${MAKE} fix-permissions

git-update: git-update-local git-update-sf

git-backup:
	[ -e $(HOME)/bak ]
	rsync -a ../bbbike-gitsf/ $(HOME)/bak/bbbike-gitsf/
	rsync -a ../bbbike-gitlocal/ $(HOME)/bak/bbbike-gitlocal/
	rsync -a ../bbbike-cvs-rcs/ $(HOME)/bak/bbbike-cvs-rcs/

######################################################################
# TESTS

# Why this does not work with -j 2? Empty script files, immeditaly finished?
#test-with-protocol:	test-with-protocol-code \
#			test-with-protocol-data
#test-with-protocol-code:
#test-with-protocol-data:

test-with-protocol: permission
	[ -d $(HOME)/log ] || mkdir $(HOME)/log
	DATE=`date +%Y%m%d`;\
	    export HARNESS_NOTTY=1;\
	    export HARNESS_TIMER=1;\
	    export BBBIKE_LONG_TESTS=1;\
	    $(MAKE) ext   >$(HOME)/log/bbbike-test-$$DATE 2>&1;\
	    $(MAKE) test >>$(HOME)/log/bbbike-test-$$DATE 2>&1 ||\
		echo "$(MAKE) test failed, please look at $(HOME)/log/bbbike-test-$$DATE for output"
	DATE=`date +%Y%m%d`;\
	    (cd data && $(MAKE) all slow-checks really-slow-checks >$(HOME)/log/bbbike-test-data-$$DATE 2>&1) ||\
		echo "$(MAKE) all slow-checks really-slow-checks failed, please look at $(HOME)/log/bbbike-test-data-$$DATE for output"

EOF
;

1;

__END__

Installation notes for www.radzeit.de: see ~/www/www.radzeit.de/Makefile

OLD NOTES:

Installation notes for www.radzeit.de

- There are two bbbike installations: /usr/local/apache/radzeit/BBBike{,2}.
  The cgi programs are in /usr/local/apache/radzeit/cgi-bin.
  The plan is to make the config files relocatable and switch easily between
  BBBike and BBBike2 --- or to make either BBBike or BBBike2 the default
  installation by adding "ScriptAlias /cgi-bin/bbbike.cgi ..." and some
  hand-editing of the config files etc.

- Steps for an data/prog update on www.radzeit.de

  # This may take a long time
  cd data_berlin_and_potsdam && make
  # This one takes not so long
  cd data_corrected && make mapfiles
  cd .. && make rsync-radzeit-test-prog-quick

- Steps for an data update only
  # This may take a long time
  cd data_berlin_and_potsdam && make
  # This one takes not so long
  cd data_corrected && make mapfiles
  cd .. && make rsync-radzeit-test-data
  cd mapserver/brb && make dist-radzeit rsync-radzeit

Installation notes for user.cs.tu-berlin.de

- install redirect script unless gd runs again
